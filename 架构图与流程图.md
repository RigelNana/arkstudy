# ArkStudy 系统架构分析与流程图

## 1. 整体系统架构图

```mermaid
graph TB
    subgraph "客户端层"
        WEB[Web前端]
        MOBILE[移动端]
        API_DOCS[API文档]
    end

    subgraph "API网关层"
        GATEWAY[Gateway<br/>Gin + JWT认证]
    end

    subgraph "微服务层"
        AUTH[Auth Service<br/>gRPC:50051]
        USER[User Service<br/>gRPC:50052]
        MATERIAL[Material Service<br/>gRPC:50053]
        LLM[LLM Service<br/>FastAPI + gRPC:50054]
        OCR[OCR Service<br/>gRPC:50055]
        QUIZ[Quiz Service<br/>gRPC:50056]
        ASR[ASR Service<br/>Whisper + gRPC:50057]
        KNOWLEDGE[Knowledge Graph<br/>Neo4j + gRPC:50058]
    end

    subgraph "数据存储层"
        PG[(PostgreSQL<br/>+pgvector)]
        REDIS[(Redis<br/>缓存)]
        MINIO[(MinIO<br/>对象存储)]
        NEO4J[(Neo4j<br/>知识图谱)]
    end

    subgraph "消息队列层"
        KAFKA[Kafka<br/>异步任务]
    end

    subgraph "基础设施层"
        K8S[Kubernetes集群]
        PROMETHEUS[Prometheus<br/>监控指标]
        GRAFANA[Grafana<br/>可视化]
        ELASTICSEARCH[Elasticsearch<br/>日志聚合]
    end

    subgraph "CI/CD层"
        GITLAB[GitLab CI/CD]
        DOCKER[Docker Registry]
    end

    %% 客户端到网关
    WEB --> GATEWAY
    MOBILE --> GATEWAY
    API_DOCS --> GATEWAY

    %% 网关到微服务
    GATEWAY --> AUTH
    GATEWAY --> USER
    GATEWAY --> MATERIAL
    GATEWAY --> LLM
    GATEWAY --> QUIZ

    %% 服务间调用
    AUTH --> PG
    USER --> PG
    MATERIAL --> PG
    MATERIAL --> MINIO
    MATERIAL --> KAFKA
    LLM --> PG
    LLM --> KAFKA
    OCR --> KAFKA
    ASR --> KAFKA
    QUIZ --> LLM
    QUIZ --> KNOWLEDGE
    KNOWLEDGE --> NEO4J

    %% 数据存储
    AUTH --> REDIS
    GATEWAY --> REDIS
    
    %% 消息队列
    KAFKA --> OCR
    KAFKA --> LLM
    KAFKA --> ASR

    %% 基础设施
    K8S --> AUTH
    K8S --> USER
    K8S --> MATERIAL
    K8S --> LLM
    K8S --> OCR
    K8S --> QUIZ
    K8S --> ASR
    K8S --> KNOWLEDGE
    K8S --> GATEWAY

    %% 监控和日志
    PROMETHEUS --> K8S
    GRAFANA --> PROMETHEUS
    ELASTICSEARCH --> K8S
    
    %% 部署
    GITLAB --> DOCKER
    DOCKER --> K8S

    style GATEWAY fill:#e1f5fe
    style AUTH fill:#f3e5f5
    style USER fill:#f3e5f5
    style MATERIAL fill:#f3e5f5
    style LLM fill:#e8f5e8
    style OCR fill:#e8f5e8
    style QUIZ fill:#e8f5e8
    style ASR fill:#e8f5e8
    style KNOWLEDGE fill:#e8f5e8
    style PG fill:#fff3e0
    style REDIS fill:#fff3e0
    style MINIO fill:#fff3e0
    style NEO4J fill:#fff3e0
    style KAFKA fill:#fce4ec
```

## 2. 完整业务流程图

```mermaid
sequenceDiagram
    participant C as 客户端
    participant G as Gateway
    participant A as Auth Service
    participant U as User Service
    participant M as Material Service
    participant L as LLM Service
    participant O as OCR Service
    participant ASR as ASR Service
    participant Q as Quiz Service
    participant KG as Knowledge Graph
    participant DB as PostgreSQL
    participant R as Redis
    participant MIO as MinIO
    participant K as Kafka

    %% 用户注册登录流程
    Note over C,DB: 用户注册与认证流程
    C->>G: POST /api/register (携带用户名, 密码, 邮箱)
    G->>U: CreateUser(gRPC)
    U->>DB: 创建 User 记录
    U-->>G: 返回成功和用户UUID
    G->>A: Register(gRPC, 包含用户UUID和密码)
    A->>U: GetUserByID(gRPC, 验证用户是否存在)
    U-->>A: 返回用户存在
    A->>DB: 创建 Auth 记录 (存储密码哈希)
    A-->>G: 注册成功
    G-->>C: HTTP 200 OK

    C->>G: POST /api/login (携带用户名, 密码)
    G->>A: Login(gRPC)
    A->>DB: 查询 Auth 记录并验证密码哈希
    A-->>G: 验证成功, 返回JWT
    G->>R: (可选) 缓存会话信息
    G-->>C: 返回JWT Token

    %% 多模态文件上传与异步处理流程
    Note over C,K: 多模态文件异步处理流程
    C->>G: POST /api/materials/upload (携带文件)
    G->>A: JWT中间件验证Token
    G->>M: UploadMaterial(gRPC)
    M->>MIO: 存储原始文件
    M->>DB: 创建Material记录, 初始状态为PENDING
    M->>K: 发送 file_processing 消息 (含 material_id, file_url)
    M-->>G: 立即返回成功响应
    G-->>C: HTTP 202 Accepted (告知客户端已接收处理)

    par
        K->>O: OCR Service消费消息
        O->>MIO: 下载文件
        O->>O: 执行OCR
        O->>M: UpdateProcessingResult(gRPC, 更新状态和文本内容)
        M->>DB: 更新 aprocessing_results 表
    and
        K->>L: LLM Service消费消息
        L->>MIO: 下载文件
        L->>L: 执行智能分块、向量化
        L->>DB: 向量数据写入 pg_vector
        L->>M: UpdateProcessingResult(gRPC, 更新状态为COMPLETED)
        M->>DB: 更新 processing_results 表
    end

    %% 智能问答 (RAG) 流程
    Note over C,L: 智能问答 (RAG) 流程
    C->>G: POST /api/ai/ask (携带问题)
    G->>A: JWT中间件验证Token
    G->>L: AskQuestion(gRPC)
    L->>L: 对问题进行向量化
    L->>DB: 在 pg_vector 中进行向量相似度搜索
    DB-->>L: 返回最相关的文本块 (Top-K)
    L->>L: 构建Prompt (包含问题 + 检索到的上下文)
    L->>L: 调用OpenAI/LLM生成答案
    L-->>G: 返回生成的答案和来源引用
    G-->>C: HTTP 200 OK (返回答案)

    %% 智能出题流程
    Note over C,Q: 智能出题流程
    C->>G: POST /api/quiz/generate
    G->>Q: GenerateQuiz (gRPC)
    Q->>L: SemanticSearch (gRPC)
    Q->>KG: 知识点分析
    Q->>Q: 多层次题目生成
    Q->>Q: 质量评估和筛选
    Q->>DB: 保存题目集
    Q-->>G: 返回题目
    G-->>C: 返回题目集合
```

## 3. 数据流向图

```mermaid
flowchart TD
    subgraph "数据输入"
        FILE[用户上传文件]
        QUERY[用户问题]
        QUIZ_REQ[出题请求]
    end

    subgraph "数据处理"
        UPLOAD[文件上传]
        OCR_PROC[OCR处理]
        VECTOR[向量化]
        SEARCH[语义检索]
        LLM_GEN[LLM生成]
        QUIZ_GEN[题目生成]
    end

    subgraph "数据存储"
        PG_META[(PostgreSQL<br/>元数据)]
        PG_VECTOR[(PostgreSQL<br/>向量数据)]
        MINIO_FILES[(MinIO<br/>文件存储)]
        REDIS_CACHE[(Redis<br/>缓存)]
    end

    subgraph "数据输出"
        ANSWER[智能答案]
        QUESTIONS[生成题目]
        MATERIALS[材料列表]
    end

    %% 文件处理流程
    FILE --> UPLOAD
    UPLOAD --> MINIO_FILES
    UPLOAD --> PG_META
    UPLOAD --> OCR_PROC
    OCR_PROC --> VECTOR
    VECTOR --> PG_VECTOR

    %% 问答流程
    QUERY --> SEARCH
    SEARCH --> PG_VECTOR
    SEARCH --> LLM_GEN
    LLM_GEN --> ANSWER
    ANSWER --> REDIS_CACHE

    %% 出题流程
    QUIZ_REQ --> SEARCH
    SEARCH --> QUIZ_GEN
    QUIZ_GEN --> PG_META
    QUIZ_GEN --> QUESTIONS

    %% 缓存策略
    PG_META --> REDIS_CACHE
    REDIS_CACHE --> MATERIALS

    style FILE fill:#e3f2fd
    style QUERY fill:#e3f2fd
    style QUIZ_REQ fill:#e3f2fd
    style ANSWER fill:#e8f5e8
    style QUESTIONS fill:#e8f5e8
    style MATERIALS fill:#e8f5e8
    style PG_META fill:#fff3e0
    style PG_VECTOR fill:#fff3e0
    style MINIO_FILES fill:#fff3e0
    style REDIS_CACHE fill:#fff3e0
```

## 4. 部署架构图

```mermaid
graph TB
    subgraph "Kubernetes集群"
        subgraph "Namespace: arkstudy"
            subgraph "Gateway层"
                GW_POD[Gateway Pod<br/>Gin Server]
            end
            
            subgraph "业务服务层"
                AUTH_POD[Auth Pod<br/>Go + gRPC]
                USER_POD[User Pod<br/>Go + gRPC]
                MAT_POD[Material Pod<br/>Go + gRPC]
                LLM_POD[LLM Pod<br/>Python + FastAPI]
                OCR_POD[OCR Pod<br/>Go + gRPC]
                QUIZ_POD[Quiz Pod<br/>Go + gRPC]
            end
            
            subgraph "数据服务层"
                PG_POD[PostgreSQL Pod<br/>+pgvector]
                REDIS_POD[Redis Pod<br/>缓存]
                MINIO_POD[MinIO Pod<br/>对象存储]
                KAFKA_POD[Kafka Pod<br/>消息队列]
            end
        end
        
        subgraph "监控层"
            PROM_POD[Prometheus Pod<br/>指标收集]
            GRAF_POD[Grafana Pod<br/>可视化]
        end
    end

    subgraph "外部服务"
        LB[负载均衡器]
        DNS[域名服务]
        REGISTRY[镜像仓库]
    end

    subgraph "存储"
        PV_PG[PostgreSQL PV]
        PV_REDIS[Redis PV] 
        PV_MINIO[MinIO PV]
        PV_KAFKA[Kafka PV]
    end

    %% 外部连接
    DNS --> LB
    LB --> GW_POD

    %% 服务间连接
    GW_POD --> AUTH_POD
    GW_POD --> USER_POD
    GW_POD --> MAT_POD
    GW_POD --> LLM_POD
    GW_POD --> QUIZ_POD
    
    MAT_POD --> OCR_POD
    MAT_POD --> LLM_POD
    QUIZ_POD --> LLM_POD

    %% 数据连接
    AUTH_POD --> PG_POD
    USER_POD --> PG_POD
    MAT_POD --> PG_POD
    LLM_POD --> PG_POD
    QUIZ_POD --> PG_POD
    
    GW_POD --> REDIS_POD
    AUTH_POD --> REDIS_POD
    
    MAT_POD --> MINIO_POD
    OCR_POD --> MINIO_POD
    
    MAT_POD --> KAFKA_POD
    LLM_POD --> KAFKA_POD
    OCR_POD --> KAFKA_POD

    %% 存储连接
    PG_POD --> PV_PG
    REDIS_POD --> PV_REDIS
    MINIO_POD --> PV_MINIO
    KAFKA_POD --> PV_KAFKA

    %% 监控连接
    PROM_POD --> GW_POD
    PROM_POD --> AUTH_POD
    PROM_POD --> USER_POD
    PROM_POD --> MAT_POD
    PROM_POD --> LLM_POD
    PROM_POD --> OCR_POD
    PROM_POD --> QUIZ_POD
    GRAF_POD --> PROM_POD

    %% 镜像拉取
    REGISTRY --> AUTH_POD
    REGISTRY --> USER_POD
    REGISTRY --> MAT_POD
    REGISTRY --> LLM_POD
    REGISTRY --> OCR_POD
    REGISTRY --> QUIZ_POD
    REGISTRY --> GW_POD

    style GW_POD fill:#e1f5fe
    style AUTH_POD fill:#f3e5f5
    style USER_POD fill:#f3e5f5
    style MAT_POD fill:#f3e5f5
    style LLM_POD fill:#e8f5e8
    style OCR_POD fill:#e8f5e8
    style QUIZ_POD fill:#e8f5e8
    style PG_POD fill:#fff3e0
    style REDIS_POD fill:#fff3e0
    style MINIO_POD fill:#fff3e0
    style KAFKA_POD fill:#fce4ec
```

## 5. CI/CD流程图

```mermaid
flowchart TD
    subgraph "开发阶段"
        DEV[开发者提交代码]
        GIT[Git Push到仓库]
    end

    subgraph "CI阶段"
        TRIGGER[触发GitLab CI]
        LINT[代码检查<br/>Go: go fmt/vet<br/>Python: ruff]
        TEST[单元测试]
        BUILD[代码构建]
    end

    subgraph "Docker构建"
        KANIKO[Kaniko构建镜像]
        PUSH[推送到Registry]
        TAG[标签管理<br/>latest/commit-sha]
    end

    subgraph "部署阶段"
        HELM_TEMPLATE[Helm模板渲染]
        K8S_APPLY[应用到Kubernetes]
        HEALTH_CHECK[健康检查]
        ROLLOUT[滚动更新]
    end

    subgraph "监控验证"
        METRICS[Prometheus指标]
        ALERT[告警检查]
        SMOKE_TEST[冒烟测试]
    end

    %% 流程连接
    DEV --> GIT
    GIT --> TRIGGER
    TRIGGER --> LINT
    LINT --> TEST
    TEST --> BUILD
    BUILD --> KANIKO
    KANIKO --> PUSH
    PUSH --> TAG
    TAG --> HELM_TEMPLATE
    HELM_TEMPLATE --> K8S_APPLY
    K8S_APPLY --> HEALTH_CHECK
    HEALTH_CHECK --> ROLLOUT
    ROLLOUT --> METRICS
    METRICS --> ALERT
    ALERT --> SMOKE_TEST

    %% 失败回滚
    HEALTH_CHECK -->|失败| ROLLBACK[回滚到上一版本]
    SMOKE_TEST -->|失败| ROLLBACK
    ROLLBACK --> HELM_TEMPLATE

    style DEV fill:#e3f2fd
    style LINT fill:#fff3e0
    style TEST fill:#fff3e0
    style BUILD fill:#fff3e0
    style KANIKO fill:#e8f5e8
    style PUSH fill:#e8f5e8
    style K8S_APPLY fill:#f3e5f5
    style ROLLOUT fill:#f3e5f5
    style METRICS fill:#fce4ec
    style ROLLBACK fill:#ffebee
```

## 6. 技术栈总览

### 后端技术栈
- **主要语言**: Go 1.22, Python 3.13
- **Web框架**: Gin (Go), FastAPI (Python)
- **RPC框架**: gRPC + Protocol Buffers
- **ORM**: GORM (Go), SQLAlchemy (Python)
- **认证**: JWT Token

### 数据存储技术栈
- **关系数据库**: PostgreSQL 16 + pgvector扩展
- **缓存**: Redis
- **对象存储**: MinIO (S3兼容)
- **消息队列**: Apache Kafka

### 容器化与编排
- **容器**: Docker
- **编排**: Kubernetes
- **配置管理**: Helm Charts
- **服务发现**: Kubernetes DNS

### DevOps工具链
- **CI/CD**: GitLab CI/CD
- **镜像构建**: Kaniko
- **监控**: Prometheus + Grafana (规划)
- **日志**: 结构化日志 (logrus, Python logging)

### AI/ML技术栈
- **LLM接口**: OpenAI兼容API，支持多种大模型
- **语音识别**: Whisper large-v3模型，支持多语言
- **文档识别**: PaddleOCR高精度识别引擎  
- **向量检索**: pgvector + HNSW索引算法
- **知识图谱**: Neo4j图数据库 + NLP实体关系抽取
- **智能出题**: 基于认知层次的多维度质量控制
- **MCP协议**: 模型上下文协议，支持AI工具协作
- **异步处理**: Kafka消息队列驱动的处理流水线

这个架构图清晰地展示了您的项目的技术复杂度和工程化水平，为面试提供了强有力的可视化支撑。